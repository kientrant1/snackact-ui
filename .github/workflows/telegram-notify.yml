name: Telegram Notification

on:
  workflow_call:
    inputs:
      pkg_name:
        required: true
        type: string
      pkg_version:
        required: true
        type: string
    secrets:
      TELEGRAM_BOT_TOKEN:
        required: true
      TELEGRAM_CHAT_ID:
        required: true

jobs:
  notify:
    runs-on: ubuntu-latest

    steps:
      - name: Send Telegram notification
        env:
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
          PKG_NAME: ${{ inputs.pkg_name }}
          PKG_VERSION: ${{ inputs.pkg_version }}
        run: |
          # Enable strict error handling:
          #   -e : Exit immediately if any command fails (prevents silent failures)
          #   -u : Treat unset variables as an error (catches typos and missing env vars)
          #   -o pipefail : Fail a pipeline if any command within it fails
          #
          # This ensures the workflow stops and reports an error if:
          #   â€¢ The curl request fails
          #   â€¢ jq can't parse the response
          #   â€¢ An environment variable like TELEGRAM_CHAT_ID is missing
          #   â€¢ Any part of a command pipeline has an error
          set -euo pipefail

          TEXT="ðŸ“¦ Published ${PKG_NAME} v${PKG_VERSION} to npm%0AðŸ”— https://www.npmjs.com/package/${PKG_NAME}"

          RESPONSE=$(curl -s -X POST "https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/sendMessage" \
            -d chat_id="${TELEGRAM_CHAT_ID}" \
            -d text="${TEXT}")

          echo "Telegram response: $RESPONSE"

          # Check if Telegram reported success
          if echo "$RESPONSE" | jq -e '.ok == true' > /dev/null 2>&1; then
            echo "Telegram notification sent successfully âœ…"
          else
            echo "Failed to send Telegram notification âŒ" >&2
            
            # Optional: show error description if present
            if echo "$RESPONSE" | jq -e '.description' > /dev/null 2>&1; then
              echo "Error: $(echo "$RESPONSE" | jq -r '.description')" >&2
            fi
            exit 1
          fi
